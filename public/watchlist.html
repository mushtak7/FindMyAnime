<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FindMyAnime ¬∑ My Library</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <style>
    .library-page {
      min-height: 100vh;
    }

    /* Hero Header */
    .library-hero {
      position: relative;
      padding: 60px 40px;
      background: linear-gradient(135deg, rgba(255, 60, 172, 0.12) 0%, rgba(120, 75, 160, 0.12) 50%, rgba(59, 130, 246, 0.1) 100%);
      border-bottom: 1px solid var(--border);
      overflow: hidden;
    }

    .library-hero::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 70% 30%, rgba(255, 60, 172, 0.08), transparent 60%);
    }

    .library-hero-content {
      position: relative;
      z-index: 1;
      max-width: 1200px;
      margin: 0 auto;
    }

    .library-hero h1 {
      font-size: 42px;
      margin: 0 0 8px 0;
      font-weight: 800;
      background: linear-gradient(90deg, #fff, #ccc);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .library-hero p {
      color: var(--muted);
      font-size: 15px;
      margin: 0 0 24px;
    }

    /* Tab Switcher */
    .library-tabs {
      display: flex;
      gap: 4px;
      background: rgba(255, 255, 255, 0.04);
      border-radius: 14px;
      padding: 4px;
      width: fit-content;
      border: 1px solid rgba(255, 255, 255, 0.06);
      margin-bottom: 24px;
    }

    .library-tab {
      padding: 10px 28px;
      border-radius: 10px;
      border: none;
      background: transparent;
      color: var(--muted);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .library-tab:hover {
      color: white;
      background: rgba(255, 255, 255, 0.06);
    }

    .library-tab.active {
      background: linear-gradient(135deg, #ff3cac, #784ba0);
      color: white;
      box-shadow: 0 4px 15px rgba(255, 60, 172, 0.3);
    }

    .library-tab .tab-count {
      background: rgba(255, 255, 255, 0.2);
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
    }

    .library-tab.active .tab-count {
      background: rgba(255, 255, 255, 0.3);
    }

    /* Stats Bar */
    .stats-bar {
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.04);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 12px;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 140px;
      transition: all 0.3s;
    }

    .stat-card:hover {
      border-color: rgba(255, 255, 255, 0.12);
      transform: translateY(-2px);
    }

    .stat-icon {
      font-size: 22px;
    }

    .stat-info h3 {
      font-size: 22px;
      margin: 0;
      font-weight: 700;
    }

    .stat-info p {
      font-size: 12px;
      color: var(--muted);
      margin: 0;
    }

    /* Filters */
    .filters-bar {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 40px;
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .filter-btn {
      padding: 8px 18px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      border-radius: 999px;
      color: var(--muted);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      font-family: inherit;
    }

    .filter-btn:hover,
    .filter-btn.active {
      background: linear-gradient(90deg, #ff3cac, #784ba0);
      border-color: transparent;
      color: white;
    }

    .search-filter {
      margin-left: auto;
      position: relative;
    }

    .search-filter input {
      padding: 10px 16px 10px 38px;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid var(--border);
      border-radius: 999px;
      color: var(--text);
      width: 220px;
      outline: none;
      font-size: 13px;
      font-family: inherit;
      transition: border-color 0.3s;
    }

    .search-filter input:focus {
      border-color: var(--accent);
    }

    .search-filter::before {
      content: "üîç";
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 13px;
      pointer-events: none;
    }

    /* Grid */
    .library-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px 40px 60px;
    }

    .library-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 20px;
    }

    /* Card */
    .library-card {
      background: rgba(255, 255, 255, 0.03);
      border-radius: 14px;
      overflow: hidden;
      transition: all 0.3s ease;
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.06);
      display: flex;
      flex-direction: column;
    }

    .library-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 16px 40px rgba(0, 0, 0, 0.3);
      border-color: rgba(255, 255, 255, 0.12);
    }

    .library-card.hidden {
      display: none;
    }

    .card-image {
      position: relative;
      aspect-ratio: 16/9;
      overflow: hidden;
    }

    .card-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.4s;
    }

    .library-card:hover .card-image img {
      transform: scale(1.05);
    }

    .card-badge {
      position: absolute;
      top: 10px;
      left: 10px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: bold;
      color: white;
      z-index: 2;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
      backdrop-filter: blur(8px);
    }

    .badge-watching,
    .badge-reading {
      background: rgba(59, 130, 246, 0.8);
    }

    .badge-completed {
      background: rgba(16, 185, 129, 0.8);
    }

    .badge-plan,
    .badge-plan_to_read {
      background: rgba(245, 158, 11, 0.8);
    }

    .badge-on_hold {
      background: rgba(156, 39, 176, 0.8);
    }

    .badge-dropped {
      background: rgba(239, 68, 68, 0.8);
    }

    .card-info {
      padding: 14px;
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
      transition: color 0.2s;
    }

    .card-title:hover {
      color: var(--accent);
    }

    /* Progress Control */
    .progress-wrapper {
      background: rgba(255, 255, 255, 0.04);
      border-radius: 8px;
      padding: 8px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-top: auto;
    }

    .progress-text {
      font-size: 12px;
      color: var(--muted);
      font-weight: 500;
    }

    .progress-text span {
      color: white;
      font-weight: 700;
    }

    .progress-btns {
      display: flex;
      gap: 4px;
    }

    .ep-btn {
      width: 26px;
      height: 26px;
      border-radius: 6px;
      border: none;
      background: rgba(255, 255, 255, 0.08);
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 14px;
      transition: all 0.2s;
    }

    .ep-btn:hover {
      background: var(--accent);
      transform: scale(1.1);
    }

    /* Controls Overlay */
    .card-actions-overlay {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      flex-direction: column;
      justify-content: center;
      padding: 16px;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .card-image:hover .card-actions-overlay {
      opacity: 1;
    }

    .status-select {
      width: 100%;
      padding: 10px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: white;
      margin-bottom: 8px;
      cursor: pointer;
      font-family: inherit;
      font-size: 13px;
    }

    .status-select option {
      background: #1a1a2e;
    }

    .remove-btn {
      width: 100%;
      padding: 10px;
      background: rgba(255, 82, 82, 0.15);
      color: #ff5252;
      border: 1px solid rgba(255, 82, 82, 0.25);
      border-radius: 8px;
      cursor: pointer;
      font-family: inherit;
      font-size: 13px;
      transition: all 0.2s;
    }

    .remove-btn:hover {
      background: rgba(255, 82, 82, 0.3);
    }

    /* Progress bar */
    .progress-bar-track {
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 3px;
      background: rgba(255, 255, 255, 0.1);
    }

    .progress-bar-fill {
      height: 100%;
      background: var(--accent);
      transition: width 0.4s ease;
    }

    /* States */
    .empty-state,
    .loading-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .empty-state h2 {
      margin: 0 0 12px;
      font-size: 20px;
    }

    .empty-btn {
      display: inline-block;
      margin-top: 12px;
      padding: 10px 24px;
      background: var(--gradient);
      color: white;
      text-decoration: none;
      border-radius: 50px;
      font-weight: 600;
      transition: transform 0.2s;
    }

    .empty-btn:hover {
      transform: translateY(-2px);
    }

    .loader {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255, 255, 255, 0.1);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .library-hero {
        padding: 40px 20px;
      }

      .library-hero h1 {
        font-size: 28px;
      }

      .stat-card {
        min-width: 120px;
        padding: 10px 14px;
      }

      .filters-bar,
      .library-content {
        padding-left: 16px;
        padding-right: 16px;
      }

      .library-grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
        gap: 14px;
      }

      .search-filter input {
        width: 160px;
      }
    }
  </style>
</head>

<body class="library-page">

  <header>
    <h1 class="logo" onclick="location.href='/'">FindMyAnime</h1>
    <nav class="nav-links">
      <a href="/" class="nav-link">üè† Home</a>
      <a href="/manga.html" class="nav-link">üìö Manga</a>
      <a href="/news.html" class="nav-link">üì∞ News</a>
      <a href="/community.html" class="nav-link">üí¨ Community</a>
    </nav>
    <div style="flex:1"></div>
    <div id="authArea"></div>
  </header>

  <section class="library-hero">
    <div class="library-hero-content">
      <h1>üìö My Library</h1>
      <p>Track your anime and manga journey all in one place.</p>

      <div class="library-tabs">
        <button class="library-tab active" onclick="switchTab('anime')" id="tabAnime">
          üì∫ Anime <span class="tab-count" id="animeTabCount">0</span>
        </button>
        <button class="library-tab" onclick="switchTab('manga')" id="tabManga">
          üìñ Manga <span class="tab-count" id="mangaTabCount">0</span>
        </button>
      </div>

      <div class="stats-bar" id="statsBar">
        <!-- Anime Stats (default) -->
        <div class="stat-card">
          <div class="stat-icon">üì∫</div>
          <div class="stat-info">
            <h3 id="statWatching">0</h3>
            <p>Watching</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">‚úÖ</div>
          <div class="stat-info">
            <h3 id="statCompleted">0</h3>
            <p>Completed</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üìÖ</div>
          <div class="stat-info">
            <h3 id="statPlan">0</h3>
            <p>Plan to Watch</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Anime Filters -->
  <div class="filters-bar" id="animeFilters">
    <button class="filter-btn active" onclick="setFilter('all')">All</button>
    <button class="filter-btn" onclick="setFilter('watching')">Watching</button>
    <button class="filter-btn" onclick="setFilter('completed')">Completed</button>
    <button class="filter-btn" onclick="setFilter('plan')">Plan to Watch</button>
    <div class="search-filter">
      <input type="text" id="searchInput" placeholder="Search my list...">
    </div>
  </div>

  <!-- Manga Filters -->
  <div class="filters-bar" id="mangaFilters" style="display:none">
    <button class="filter-btn active" onclick="setMangaFilter('all')">All</button>
    <button class="filter-btn" onclick="setMangaFilter('reading')">Reading</button>
    <button class="filter-btn" onclick="setMangaFilter('completed')">Completed</button>
    <button class="filter-btn" onclick="setMangaFilter('plan_to_read')">Plan to Read</button>
    <button class="filter-btn" onclick="setMangaFilter('on_hold')">On Hold</button>
    <button class="filter-btn" onclick="setMangaFilter('dropped')">Dropped</button>
    <div class="search-filter">
      <input type="text" id="mangaSearchInput" placeholder="Search manga...">
    </div>
  </div>

  <main class="library-content">
    <div class="library-grid" id="libraryGrid">
      <div class="loading-state">
        <div class="loader"></div>
        <p>Syncing your library...</p>
      </div>
    </div>
  </main>

  <script>
    const API_BASE = "";
    let currentTab = 'anime';

    // =====================
    // ANIME STATE
    // =====================
    let allAnime = [];
    let currentFilter = 'all';

    const getStorage = (key) => JSON.parse(localStorage.getItem(key)) || {};
    const setStorage = (key, data) => localStorage.setItem(key, JSON.stringify(data));

    const getStatus = (id) => getStorage('anime_statuses')[id] || 'plan';
    const saveStatus = (id, status) => {
      const map = getStorage('anime_statuses');
      map[id] = status;
      setStorage('anime_statuses', map);
      updateAnimeStats();
    };
    const getProgress = (id) => getStorage('anime_progress')[id] || 0;
    const saveProgress = (id, ep) => {
      const map = getStorage('anime_progress');
      map[id] = ep;
      setStorage('anime_progress', map);
    };

    // =====================
    // MANGA STATE
    // =====================
    let allManga = [];
    let currentMangaFilter = 'all';
    let mangaLibraryData = [];

    // =====================
    // TAB SWITCHING
    // =====================
    window.switchTab = function (tab) {
      currentTab = tab;
      document.getElementById('tabAnime').classList.toggle('active', tab === 'anime');
      document.getElementById('tabManga').classList.toggle('active', tab === 'manga');
      document.getElementById('animeFilters').style.display = tab === 'anime' ? 'flex' : 'none';
      document.getElementById('mangaFilters').style.display = tab === 'manga' ? 'flex' : 'none';

      if (tab === 'anime') {
        updateStatsBarForAnime();
        renderAnimeGrid();
      } else {
        updateStatsBarForManga();
        renderMangaGrid();
      }
    };

    function updateStatsBarForAnime() {
      document.getElementById('statsBar').innerHTML = `
        <div class="stat-card"><div class="stat-icon">üì∫</div><div class="stat-info"><h3 id="statWatching">0</h3><p>Watching</p></div></div>
        <div class="stat-card"><div class="stat-icon">‚úÖ</div><div class="stat-info"><h3 id="statCompleted">0</h3><p>Completed</p></div></div>
        <div class="stat-card"><div class="stat-icon">üìÖ</div><div class="stat-info"><h3 id="statPlan">0</h3><p>Plan to Watch</p></div></div>
      `;
      updateAnimeStats();
    }

    function updateStatsBarForManga() {
      document.getElementById('statsBar').innerHTML = `
        <div class="stat-card"><div class="stat-icon">üìñ</div><div class="stat-info"><h3 id="statReading">0</h3><p>Reading</p></div></div>
        <div class="stat-card"><div class="stat-icon">‚úÖ</div><div class="stat-info"><h3 id="statMangaCompleted">0</h3><p>Completed</p></div></div>
        <div class="stat-card"><div class="stat-icon">üìã</div><div class="stat-info"><h3 id="statPlanRead">0</h3><p>Plan to Read</p></div></div>
        <div class="stat-card"><div class="stat-icon">‚è∏Ô∏è</div><div class="stat-info"><h3 id="statOnHold">0</h3><p>On Hold</p></div></div>
      `;
      updateMangaStats();
    }

    // =====================
    // INIT
    // =====================
    document.addEventListener("DOMContentLoaded", () => {
      const authArea = document.getElementById("authArea");

      fetch(`${API_BASE}/api/me`, { credentials: "include" })
        .then(r => r.json())
        .then(d => {
          if (d.user) {
            authArea.innerHTML = `
              <a href="/watchlist.html" class="auth-link" style="color:var(--accent)">üìö Library</a>
              <span style="color:var(--muted)">üë§ ${d.user.username}</span>
              <button class="auth-link" onclick="logout()">Logout</button>
            `;
            loadAnimeWatchlist();
            loadMangaLibrary();
          } else {
            showLoginState();
          }
        })
        .catch(() => showLoginState());

      document.getElementById('searchInput').addEventListener('input', (e) => {
        applyAnimeFilter(currentFilter, e.target.value);
      });
      document.getElementById('mangaSearchInput').addEventListener('input', (e) => {
        applyMangaFilter(currentMangaFilter, e.target.value);
      });
    });

    window.logout = () => fetch(`${API_BASE}/api/logout`, {
      method: "POST", credentials: "include"
    }).then(() => location.reload());

    // =====================
    // ANIME LOADING
    // =====================
    async function loadAnimeWatchlist() {
      try {
        const res = await fetch(`${API_BASE}/api/watchlist`, { credentials: "include" });
        if (res.status === 401) { showLoginState(); return; }
        const ids = await res.json();

        document.getElementById('animeTabCount').textContent = ids.length;

        if (!ids || !ids.length) {
          if (currentTab === 'anime') renderAnimeGrid();
          return;
        }

        const statusMap = getStorage('anime_statuses');
        ids.forEach(id => { if (!statusMap[id]) saveStatus(id, 'plan'); });

        for (const id of ids) {
          await fetchAndRenderAnimeCard(id);
        }
        updateAnimeStats();
        if (currentTab === 'anime') renderAnimeGrid();
      } catch (err) {
        console.error(err);
        if (currentTab === 'anime') {
          document.getElementById("libraryGrid").innerHTML = `<div class="empty-state"><p>Error loading anime watchlist</p></div>`;
        }
      }
    }

    async function fetchAndRenderAnimeCard(id) {
      try {
        const res = await fetch(`https://api.jikan.moe/v4/anime/${id}`);
        const data = await res.json();
        const anime = data.data;
        anime.userStatus = getStatus(id);
        anime.progress = getProgress(id);
        allAnime.push(anime);
      } catch (e) { console.error(e); }
    }

    function renderAnimeGrid() {
      const grid = document.getElementById('libraryGrid');
      if (!allAnime.length) {
        grid.innerHTML = `<div class="empty-state"><h2>Your anime list is empty</h2><p>Start adding anime to track your progress!</p><a href="/" class="empty-btn">üîç Find Anime</a></div>`;
        return;
      }
      grid.innerHTML = '';
      allAnime.forEach(anime => {
        const card = createAnimeCard(anime);
        grid.appendChild(card);
      });
      applyAnimeFilter(currentFilter, document.getElementById('searchInput').value);
    }

    function createAnimeCard(anime) {
      const card = document.createElement('div');
      card.className = 'library-card';
      card.dataset.id = anime.mal_id;
      card.dataset.type = 'anime';
      populateAnimeCard(card, anime);
      return card;
    }

    function populateAnimeCard(card, anime) {
      const labels = { watching: 'Watching', completed: 'Completed', plan: 'Plan to Watch' };
      const totalEps = anime.episodes || '?';
      const pct = (typeof totalEps === 'number') ? Math.min((anime.progress / totalEps) * 100, 100) : 0;

      card.innerHTML = `
        <span class="card-badge badge-${anime.userStatus}">${labels[anime.userStatus] || 'Plan to Watch'}</span>
        <div class="card-image">
          <img src="${anime.images?.jpg?.large_image_url || anime.images?.jpg?.image_url || ''}" alt="${anime.title}" loading="lazy">
          <div class="card-actions-overlay">
            <select class="status-select" onchange="updateAnimeStatus(${anime.mal_id}, this.value)">
              <option value="watching" ${anime.userStatus === 'watching' ? 'selected' : ''}>üì∫ Watching</option>
              <option value="completed" ${anime.userStatus === 'completed' ? 'selected' : ''}>‚úÖ Completed</option>
              <option value="plan" ${anime.userStatus === 'plan' ? 'selected' : ''}>üìÖ Plan to Watch</option>
            </select>
            <button class="remove-btn" onclick="removeAnime(${anime.mal_id})">üóëÔ∏è Remove</button>
          </div>
          <div class="progress-bar-track"><div class="progress-bar-fill" style="width:${pct}%"></div></div>
        </div>
        <div class="card-info">
          <div class="card-title" onclick="location.href='/anime.html?id=${anime.mal_id}'">${anime.title}</div>
          <div class="progress-wrapper">
            <div class="progress-text">EP <span>${anime.progress}</span> / ${totalEps}</div>
            <div class="progress-btns">
              <button class="ep-btn" onclick="changeProgress(${anime.mal_id}, -1)">‚àí</button>
              <button class="ep-btn" onclick="changeProgress(${anime.mal_id}, 1)">+</button>
            </div>
          </div>
        </div>
      `;
    }

    // =====================
    // MANGA LOADING
    // =====================
    async function loadMangaLibrary() {
      try {
        const res = await fetch(`${API_BASE}/api/manga-library`, { credentials: "include" });
        if (res.status === 401) return;
        mangaLibraryData = await res.json();

        document.getElementById('mangaTabCount').textContent = mangaLibraryData.length;

        if (!mangaLibraryData.length) return;

        for (const entry of mangaLibraryData) {
          await fetchMangaDetails(entry);
        }
        if (currentTab === 'manga') renderMangaGrid();
      } catch (err) {
        console.error('Error loading manga library:', err);
      }
    }

    async function fetchMangaDetails(entry) {
      try {
        const res = await fetch(`https://api.jikan.moe/v4/manga/${entry.manga_id}`);
        const data = await res.json();
        const manga = data.data;
        manga.libraryStatus = entry.status;
        manga.chaptersRead = entry.chapters_read || 0;
        manga.volumesRead = entry.volumes_read || 0;
        allManga.push(manga);
      } catch (e) { console.error(e); }
    }

    function renderMangaGrid() {
      const grid = document.getElementById('libraryGrid');
      if (!allManga.length) {
        grid.innerHTML = `<div class="empty-state"><h2>Your manga list is empty</h2><p>Start adding manga to track your reading progress!</p><a href="/manga.html" class="empty-btn">üìö Browse Manga</a></div>`;
        return;
      }
      grid.innerHTML = '';
      allManga.forEach(manga => {
        const card = createMangaCard(manga);
        grid.appendChild(card);
      });
      applyMangaFilter(currentMangaFilter, document.getElementById('mangaSearchInput').value);
    }

    function createMangaCard(manga) {
      const card = document.createElement('div');
      card.className = 'library-card';
      card.dataset.id = manga.mal_id;
      card.dataset.type = 'manga';
      populateMangaCard(card, manga);
      return card;
    }

    function populateMangaCard(card, manga) {
      const labels = {
        reading: 'üìñ Reading', completed: '‚úÖ Completed',
        plan_to_read: 'üìã Plan to Read', on_hold: '‚è∏Ô∏è On Hold', dropped: '‚ùå Dropped'
      };
      const totalCh = manga.chapters || '?';
      const totalVol = manga.volumes || '?';
      const pct = (typeof totalCh === 'number' && totalCh > 0) ? Math.min((manga.chaptersRead / totalCh) * 100, 100) : 0;

      card.innerHTML = `
        <span class="card-badge badge-${manga.libraryStatus}">${labels[manga.libraryStatus] || 'üìã Plan to Read'}</span>
        <div class="card-image">
          <img src="${manga.images?.jpg?.large_image_url || manga.images?.jpg?.image_url || ''}" alt="${manga.title}" loading="lazy">
          <div class="card-actions-overlay">
            <select class="status-select" onchange="updateMangaStatus(${manga.mal_id}, this.value)">
              <option value="reading" ${manga.libraryStatus === 'reading' ? 'selected' : ''}>üìñ Reading</option>
              <option value="completed" ${manga.libraryStatus === 'completed' ? 'selected' : ''}>‚úÖ Completed</option>
              <option value="plan_to_read" ${manga.libraryStatus === 'plan_to_read' ? 'selected' : ''}>üìã Plan to Read</option>
              <option value="on_hold" ${manga.libraryStatus === 'on_hold' ? 'selected' : ''}>‚è∏Ô∏è On Hold</option>
              <option value="dropped" ${manga.libraryStatus === 'dropped' ? 'selected' : ''}>‚ùå Dropped</option>
            </select>
            <button class="remove-btn" onclick="removeManga(${manga.mal_id})">üóëÔ∏è Remove</button>
          </div>
          <div class="progress-bar-track"><div class="progress-bar-fill" style="width:${pct}%"></div></div>
        </div>
        <div class="card-info">
          <div class="card-title" onclick="location.href='/manga-details.html?id=${manga.mal_id}'">${manga.title}</div>
          <div class="progress-wrapper">
            <div class="progress-text">CH <span>${manga.chaptersRead}</span> / ${totalCh}</div>
            <div class="progress-btns">
              <button class="ep-btn" onclick="changeMangaProgress(${manga.mal_id}, -1)">‚àí</button>
              <button class="ep-btn" onclick="changeMangaProgress(${manga.mal_id}, 1)">+</button>
            </div>
          </div>
        </div>
      `;
    }

    // =====================
    // ANIME ACTIONS
    // =====================
    window.changeProgress = function (id, amount) {
      const anime = allAnime.find(a => a.mal_id === id);
      if (!anime) return;
      let newEp = anime.progress + amount;
      if (newEp < 0) newEp = 0;
      if (anime.episodes && newEp > anime.episodes) newEp = anime.episodes;
      if (anime.episodes && newEp === anime.episodes && anime.userStatus !== 'completed') {
        anime.userStatus = 'completed';
        saveStatus(id, 'completed');
      }
      anime.progress = newEp;
      saveProgress(id, newEp);
      const card = document.querySelector(`.library-card[data-id="${id}"][data-type="anime"]`);
      if (card) populateAnimeCard(card, anime);
      applyAnimeFilter(currentFilter, document.getElementById('searchInput').value);
      updateAnimeStats();
    };

    window.updateAnimeStatus = function (id, newStatus) {
      saveStatus(id, newStatus);
      const anime = allAnime.find(a => a.mal_id === id);
      if (anime) {
        anime.userStatus = newStatus;
        const card = document.querySelector(`.library-card[data-id="${id}"][data-type="anime"]`);
        if (card) populateAnimeCard(card, anime);
      }
      updateAnimeStats();
      applyAnimeFilter(currentFilter, document.getElementById('searchInput').value);
    };

    window.removeAnime = async function (id) {
      if (!confirm('Remove from library?')) return;
      try {
        await fetch(`${API_BASE}/api/watchlist/remove`, {
          method: "POST", headers: { "Content-Type": "application/json" },
          credentials: "include", body: JSON.stringify({ animeId: id })
        });
        allAnime = allAnime.filter(a => a.mal_id !== id);
        document.querySelector(`.library-card[data-id="${id}"][data-type="anime"]`)?.remove();
        const sMap = getStorage('anime_statuses'); delete sMap[id]; setStorage('anime_statuses', sMap);
        const pMap = getStorage('anime_progress'); delete pMap[id]; setStorage('anime_progress', pMap);
        updateAnimeStats();
        document.getElementById('animeTabCount').textContent = allAnime.length;
        if (allAnime.length === 0) renderAnimeGrid();
      } catch (e) { alert('Failed to remove'); }
    };

    // =====================
    // MANGA ACTIONS
    // =====================
    window.changeMangaProgress = async function (id, amount) {
      const manga = allManga.find(m => m.mal_id === id);
      if (!manga) return;
      let newCh = manga.chaptersRead + amount;
      if (newCh < 0) newCh = 0;
      if (manga.chapters && newCh > manga.chapters) newCh = manga.chapters;
      if (manga.chapters && newCh === manga.chapters && manga.libraryStatus !== 'completed') {
        manga.libraryStatus = 'completed';
      }
      manga.chaptersRead = newCh;

      try {
        await fetch(`${API_BASE}/api/manga-library/update`, {
          method: "POST", headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ mangaId: id, chaptersRead: newCh, status: manga.libraryStatus })
        });
      } catch (e) { console.error(e); }

      const card = document.querySelector(`.library-card[data-id="${id}"][data-type="manga"]`);
      if (card) populateMangaCard(card, manga);
      updateMangaStats();
    };

    window.updateMangaStatus = async function (id, newStatus) {
      const manga = allManga.find(m => m.mal_id === id);
      if (manga) manga.libraryStatus = newStatus;
      try {
        await fetch(`${API_BASE}/api/manga-library/update`, {
          method: "POST", headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify({ mangaId: id, status: newStatus })
        });
      } catch (e) { console.error(e); }

      const card = document.querySelector(`.library-card[data-id="${id}"][data-type="manga"]`);
      if (card) populateMangaCard(card, manga);
      updateMangaStats();
      applyMangaFilter(currentMangaFilter, document.getElementById('mangaSearchInput').value);
    };

    window.removeManga = async function (id) {
      if (!confirm('Remove from library?')) return;
      try {
        await fetch(`${API_BASE}/api/manga-library/remove`, {
          method: "POST", headers: { "Content-Type": "application/json" },
          credentials: "include", body: JSON.stringify({ mangaId: id })
        });
        allManga = allManga.filter(m => m.mal_id !== id);
        document.querySelector(`.library-card[data-id="${id}"][data-type="manga"]`)?.remove();
        updateMangaStats();
        document.getElementById('mangaTabCount').textContent = allManga.length;
        if (allManga.length === 0) renderMangaGrid();
      } catch (e) { alert('Failed to remove'); }
    };

    // =====================
    // FILTERS
    // =====================
    window.setFilter = function (filter) {
      currentFilter = filter;
      document.querySelectorAll('#animeFilters .filter-btn').forEach(b => {
        b.classList.toggle('active', b.innerText.toLowerCase().includes(filter === 'plan' ? 'plan' : filter));
        if (filter === 'all' && b.innerText === 'All') b.classList.add('active');
      });
      applyAnimeFilter(filter, document.getElementById('searchInput').value);
    };

    function applyAnimeFilter(filter, search) {
      search = (search || '').toLowerCase();
      document.querySelectorAll('.library-card[data-type="anime"]').forEach(card => {
        const id = parseInt(card.dataset.id);
        const anime = allAnime.find(a => a.mal_id === id);
        if (!anime) return;
        const matchesFilter = filter === 'all' || anime.userStatus === filter;
        const matchesSearch = anime.title.toLowerCase().includes(search);
        card.classList.toggle('hidden', !(matchesFilter && matchesSearch));
      });
    }

    window.setMangaFilter = function (filter) {
      currentMangaFilter = filter;
      document.querySelectorAll('#mangaFilters .filter-btn').forEach(b => {
        b.classList.remove('active');
      });
      event.target.classList.add('active');
      applyMangaFilter(filter, document.getElementById('mangaSearchInput').value);
    };

    function applyMangaFilter(filter, search) {
      search = (search || '').toLowerCase();
      document.querySelectorAll('.library-card[data-type="manga"]').forEach(card => {
        const id = parseInt(card.dataset.id);
        const manga = allManga.find(m => m.mal_id === id);
        if (!manga) return;
        const matchesFilter = filter === 'all' || manga.libraryStatus === filter;
        const matchesSearch = manga.title.toLowerCase().includes(search);
        card.classList.toggle('hidden', !(matchesFilter && matchesSearch));
      });
    }

    // =====================
    // STATS
    // =====================
    function updateAnimeStats() {
      const counts = { watching: 0, completed: 0, plan: 0 };
      allAnime.forEach(a => { if (counts[a.userStatus] !== undefined) counts[a.userStatus]++; });
      const el = (id) => document.getElementById(id);
      if (el('statWatching')) el('statWatching').innerText = counts.watching;
      if (el('statCompleted')) el('statCompleted').innerText = counts.completed;
      if (el('statPlan')) el('statPlan').innerText = counts.plan;
    }

    function updateMangaStats() {
      const counts = { reading: 0, completed: 0, plan_to_read: 0, on_hold: 0, dropped: 0 };
      allManga.forEach(m => { if (counts[m.libraryStatus] !== undefined) counts[m.libraryStatus]++; });
      const el = (id) => document.getElementById(id);
      if (el('statReading')) el('statReading').innerText = counts.reading;
      if (el('statMangaCompleted')) el('statMangaCompleted').innerText = counts.completed;
      if (el('statPlanRead')) el('statPlanRead').innerText = counts.plan_to_read;
      if (el('statOnHold')) el('statOnHold').innerText = counts.on_hold;
    }

    function showLoginState() {
      document.getElementById("libraryGrid").innerHTML = `<div class="empty-state"><h2>Please Login</h2><p>Sign in to access your library.</p><a href="/login.html" class="empty-btn">Sign In</a></div>`;
    }
  </script>
  <script src="theme-toggle.js" defer></script>
</body>

</html>